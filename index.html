<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบสมาชิก LIFF</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; color: #333; }
    .container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
    button { background-color: #3b82f6; color: white; border: none; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; }
    button:hover { background-color: #2563eb; }
    #loading { display: none; text-align: center; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { margin: 20px auto; width: 50px; height: 50px; border: 6px solid #e0e7ff; border-top: 6px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #dialog {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #dialog-content {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      font-size: 18px;
      text-align: center;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    /* New styles for profile card */
    .profile-card {
      background: linear-gradient(to right, #f43f5e, #f97316);
      color: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      box-shadow: 0 8px 20px rgba(244, 62, 94, 0.3);
    }
    .profile-card h3 {
      margin: 10px 0 5px;
      font-weight: 700;
      font-size: 24px;
    }
    .profile-card small {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      opacity: 0.85;
    }
    .profile-info {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .profile-info div {
      text-align: center;
      font-weight: 600;
    }
    .profile-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 2px solid white;
      object-fit: cover;
      margin: 0 auto 10px;
      background: white;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.3.0/dist/dotlottie-wc.js" type="module"></script>
</head>
<body>

<!-- Loading -->
<div id="loading" class="container hidden" style="display:flex; flex-direction:column; align-items:center; text-align:center;">
  <dotlottie-wc src="https://lottie.host/4d93bcaf-8e23-45e2-ac59-6d7c52e76681/AtVSLy5hEN.lottie" autoplay loop style="width:100px;height:100px;"></dotlottie-wc>
  <p>กำลังโหลดข้อมูล...</p>
</div>

<!-- Dashboard -->
<div class="container hidden" id="dashboard">
  <div class="profile-card">
    <img src="https://via.placeholder.com/70" alt="avatar" class="profile-avatar">
    <h3 id="member-name">-</h3>
    <small>หมายเลขสมาชิก: <span id="member-id">123456</span></small>
    <div class="profile-info">
      <div>
        <div style="font-size: 20px;" id="member-total">-</div>
        <div>ยอดซื้อ (บาท)</div>
      </div>
      <div>
        <div style="font-size: 20px;">5</div>
        <div>คูปอง</div>
      </div>
    </div>
  </div>
  <h3 style="margin-top: 30px;">ประวัติคำสั่งซื้อ:</h3>
  <ul id="order-list"></ul>
</div>

<!-- Register Form -->
<div class="container hidden" id="register-form">
  <h2 style="text-align:center;">ลงทะเบียนสมาชิก</h2>
  <input type="text" id="name" placeholder="ชื่อ" required>
  <input type="tel" id="phone" placeholder="เบอร์โทรศัพท์" required>
  <button onclick="submitRegistration()">ส่งข้อมูล</button>
</div>

<!-- Dialog Popup -->
<div id="dialog" class="hidden">
  <div id="dialog-content"></div>
</div>

<script>
function showLoading() {
  document.getElementById("loading").style.display = "flex";
  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("register-form").classList.add("hidden");
}

function hideLoading() {
  document.getElementById("loading").style.display = "none";
  document.getElementById("loading").classList.add("hidden");
}


async function checkMembership(uid) {
  showLoading();
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbz5Of6vINT9zfF-nWL72zr2ua4NcDl_h2QVWDBto0pct6cAfbxKqgN3oTSKW-Qx1HU/exec?userId=" + uid);
    const text = await res.text();
    console.log("Response text", text);
    const data = JSON.parse(text);

    if (data && !data.error) {
      // document.getElementById("member-name").textContent = data.name || "-";
      document.getElementById("member-id").textContent = uid || "-";
      let total = parseFloat(data.total) || 0;
      document.getElementById("member-total").textContent = total.toFixed(2);

      const orderList = document.getElementById("order-list");
      orderList.innerHTML = "";
      if (Array.isArray(data.orders)) {
        data.orders.forEach(order => {
          const li = document.createElement("li");
          let dateStr = "-";
          if (order.date) {
            const d = new Date(order.date);
            dateStr = new Intl.DateTimeFormat("th-TH", { day: "numeric", month: "short", year: "numeric" }).format(d);
          }
          li.textContent = `${dateStr} : ${order.amount} บาท - ${order.note}`;
          orderList.appendChild(li);
        });
      }

      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("register-form").classList.add("hidden");
    } else {
      document.getElementById("register-form").classList.remove("hidden");
      document.getElementById("dashboard").classList.add("hidden");
    }
  } catch (err) {
    console.error("Fetch member info error", err);
    showDialog("โหลดข้อมูลสมาชิกไม่สำเร็จ");
    document.getElementById("register-form").classList.remove("hidden");
    document.getElementById("dashboard").classList.add("hidden");
  } finally {
    hideLoading();
  }
}

function showDialog(message) {
  const dialog = document.getElementById("dialog");
  const content = document.getElementById("dialog-content");
  content.textContent = message;
  dialog.classList.remove("hidden");
  setTimeout(() => {
    dialog.classList.add("hidden");
  }, 2000);
}

async function initLiff() {
  showLoading();
  try {
    await liff.init({ liffId: "2007314988-2nrybXKL" }); // เปลี่ยน liffId ให้ตรงกับของคุณ
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      const profile = await liff.getProfile();
      // Set profile avatar to user's LINE profile picture
      document.querySelector(".profile-avatar").src = profile.pictureUrl;
      document.getElementById("member-name").textContent = profile.displayName;
      const uid = profile.userId;
      console.log("User ID:", uid);
      await checkMembership(uid);
    }
  } catch (err) {
    console.error("LIFF init failed", err);
    showDialog("ไม่สามารถเริ่มต้น LIFF ได้");
  }
}

document.addEventListener("DOMContentLoaded", initLiff);
</script>

</body>
</html>
